# Back-of-the-envelope Calculations

## Что это такое?

**Back-of-the-envelope calculations** (расчеты "на салфетке") — это быстрые приблизительные вычисления, которые помогают оценить масштаб системы и принять архитектурные решения. Название пошло от практики инженеров делать быстрые расчеты на чем угодно под рукой — салфетке, конверте, доске.

Эти расчеты критически важны для:
- Определения требуемой инфраструктуры
- Оценки стоимости системы
- Выявления потенциальных bottlenecks
- Обоснования архитектурных решений
- Прохождения system design интервью

## Зачем нужны оценки?

Представьте, что вам нужно спроектировать систему хранения фотографий:
- Сколько серверов понадобится?
- Какой объем storage?
- Какая пропускная способность сети нужна?
- Сколько это будет стоить?

Без расчетов вы будете гадать. С расчетами — сделаете обоснованный выбор.

## Базовые степени двойки

Запомните эти значения — они основа всех расчетов:

| Степень | Точное значение | Приблизительно | Название |
|---------|-----------------|----------------|----------|
| 10 | 1,024 | 1 тысяча | 1 KB |
| 20 | 1,048,576 | 1 миллион | 1 MB |
| 30 | 1,073,741,824 | 1 миллиард | 1 GB |
| 40 | 1,099,511,627,776 | 1 триллион | 1 TB |
| 50 | 1,125,899,906,842,624 | 1 квадриллион | 1 PB |

**Практический совет**: В расчетах используйте округления:
- 2^10 ≈ 10^3 (1 тысяча)
- 2^20 ≈ 10^6 (1 миллион)
- 2^30 ≈ 10^9 (1 миллиард)

## Временные величины

Запомните эти соотношения:

| Единица | Секунд |
|---------|--------|
| 1 минута | 60 |
| 1 час | 3,600 (≈ 3.6K) |
| 1 день | 86,400 (≈ 100K) |
| 1 неделя | 604,800 (≈ 600K) |
| 1 месяц | 2,592,000 (≈ 2.5M) |
| 1 год | 31,536,000 (≈ 30M) |

**Полезные упрощения**:
- 1 день ≈ 100K секунд (на самом деле 86.4K)
- 1 месяц ≈ 2.5M секунд
- 1 год ≈ 30M секунд (легко запомнить: 30 million seconds)

## Порядки величин в распределенных системах

### Количество пользователей
- **Малый стартап**: 1K - 10K users
- **Средний сервис**: 100K - 1M users
- **Крупный сервис**: 10M - 100M users
- **Глобальный сервис**: 1B+ users (Facebook, Google)

### Requests Per Second (RPS)
- **Низкая нагрузка**: < 100 RPS
- **Средняя нагрузка**: 100 - 1K RPS
- **Высокая нагрузка**: 1K - 10K RPS
- **Экстремальная**: 10K+ RPS

### Storage
- **Текст**: 1KB - 10KB на пост/сообщение
- **Изображение**: 100KB - 2MB
- **Видео (HD, 1 час)**: 1GB - 5GB
- **Видео (4K, 1 час)**: 7GB - 15GB

## Методика расчетов

### Шаг 1: Определите ключевые метрики

Для любой системы выделите:
1. **Пользователи**: DAU (Daily Active Users), MAU (Monthly Active Users)
2. **Операции**: сколько действий делает типичный пользователь
3. **Размер данных**: сколько данных генерирует одна операция
4. **Retention**: как долго хранятся данные

### Шаг 2: Рассчитайте QPS (Queries Per Second)

Формула:
```
QPS = (Total daily operations) / (Seconds in a day)
QPS = (DAU × Operations per user) / 86400
```

**Упрощенно**: делите на 100,000 (вместо 86,400) для удобства.

**Peak QPS**: умножьте на 2-5x для учета неравномерной нагрузки.

### Шаг 3: Рассчитайте Storage

Формула:
```
Total Storage = Operations per day × Data per operation × Days stored
```

Добавьте:
- **Метаданные**: +20-30%
- **Репликация**: ×2 или ×3 (для надежности)
- **Индексы БД**: +20-50%

### Шаг 4: Рассчитайте Bandwidth

**Входящий трафик** (Ingress):
```
Ingress = Write QPS × Average data size
```

**Исходящий трафик** (Egress):
```
Egress = Read QPS × Average data size
```

Обычно Read QPS = 10x-100x Write QPS (зависит от системы).

## Примеры расчетов

### Пример 1: Twitter-like система

**Требования**:
- 300M пользователей
- 50% пользователей активны ежедневно (150M DAU)
- Каждый постит 2 твита в день
- Каждый читает 200 твитов в день
- Средний твит: 280 символов + метаданные = 500 bytes

**Расчеты**:

**Write QPS**:
```
Write operations per day = 150M × 2 = 300M
Write QPS = 300M / 100K ≈ 3K writes/sec
Peak Write QPS = 3K × 3 = 9K writes/sec
```

**Read QPS**:
```
Read operations per day = 150M × 200 = 30B (30 billion)
Read QPS = 30B / 100K = 300K reads/sec
Peak Read QPS = 300K × 3 = 900K reads/sec
```

**Storage (5 лет)**:
```
Daily data = 300M × 500 bytes = 150GB/day
Data per year = 150GB × 365 ≈ 55TB/year
5 years = 55TB × 5 = 275TB

With metadata (+30%): 275TB × 1.3 = 357TB
With replication (×3): 357TB × 3 ≈ 1.1PB
```

**Bandwidth**:
```
Ingress = 3K writes/sec × 500 bytes = 1.5MB/sec
Egress = 300K reads/sec × 500 bytes = 150MB/sec
```

### Пример 2: Instagram-like система

**Требования**:
- 500M пользователей
- 200M DAU
- Каждый загружает 1 фото в день
- Каждый просматривает 50 фото в день
- Средний размер фото: 2MB

**Расчеты**:

**Write QPS**:
```
Write operations = 200M × 1 = 200M/day
Write QPS = 200M / 100K = 2K writes/sec
Peak Write QPS = 2K × 2 = 4K writes/sec
```

**Read QPS**:
```
Read operations = 200M × 50 = 10B/day
Read QPS = 10B / 100K = 100K reads/sec
```

**Storage (10 лет)**:
```
Daily data = 200M × 2MB = 400TB/day
Data per year = 400TB × 365 = 146PB/year
10 years = 146PB × 10 = 1,460PB = 1.46EB (exabyte!)

With replication (×3): 1.46EB × 3 = 4.38EB
```

**Bandwidth**:
```
Ingress = 2K writes/sec × 2MB = 4GB/sec
Egress = 100K reads/sec × 2MB = 200GB/sec
```

**Вывод**: Нужен CDN для доставки изображений!

### Пример 3: URL Shortener

**Требования**:
- 100M новых URLs в месяц
- Read/Write ratio = 100:1
- URL хранятся вечно
- Короткий URL: 7 символов
- Оригинальный URL: средний 200 символов

**Расчеты**:

**Write QPS**:
```
Write operations = 100M / month
Write QPS = 100M / 2.5M ≈ 40 writes/sec
```

**Read QPS**:
```
Read QPS = 40 × 100 = 4K reads/sec
```

**Storage (10 лет)**:
```
URLs per 10 years = 100M × 12 × 10 = 12B URLs

Data per URL:
- Short URL: 7 bytes
- Original URL: 200 bytes
- Metadata (created_at, user_id, etc.): 50 bytes
Total: ~250 bytes

Storage = 12B × 250 bytes = 3TB
With indexes (+50%): 3TB × 1.5 = 4.5TB
```

**Уникальных комбинаций**:
```
7 символов, base62 (a-z, A-Z, 0-9):
62^7 = 3.5 trillion возможных URLs
```
Достаточно на сотни лет!

## Оптимизация расчетов для интервью

### Используйте "магические" числа

- **100K секунд в дне** (вместо 86.4K)
- **2.5M секунд в месяце**
- **30M секунд в году**
- **1K ≈ 10^3**
- **1M ≈ 10^6**
- **1B ≈ 10^9**

### Округляйте агрессивно

На интервью точность не критична. Ошибка в 2x допустима.

**Плохо**: "86,432 секунды в дне, умножим на..."
**Хорошо**: "Примерно 100K секунд в дне, получается..."

### Озвучивайте допущения

"Предположу, что read/write ratio = 100:1, типично для social media..."

"Возьмем средний размер изображения 2MB..."

"Будем хранить данные 5 лет..."

### Показывайте ход мыслей

Интервьюера интересует не только результат, но и процесс:
- Какие метрики вы выбрали
- Почему сделали определенные допущения
- Как структурировали расчет

## Типичные ошибки

### 1. Забывают про репликацию
Storage нужен не только для хранения данных, но и для копий (обычно ×3).

### 2. Игнорируют метаданные
Кроме payload, есть timestamps, user IDs, indexes — добавляйте 20-50%.

### 3. Не учитывают пиковую нагрузку
Средний QPS и пиковый QPS могут различаться в 5-10 раз.

### 4. Путают единицы измерения
- 1MB = 1,000KB (десятичная система, для storage)
- 1MiB = 1,024KB (двоичная система, для памяти)

На интервью можно использовать десятичную для простоты.

### 5. Слишком точные расчеты
"83,472.6 QPS" → "примерно 80K QPS"

## Расширенные расчеты

### Количество серверов

Если один сервер обрабатывает 1K RPS:
```
Servers needed = Total QPS / 1K RPS per server
```

С учетом резерва (добавьте 30-50%).

### Стоимость

**Storage** (AWS S3):
- $0.023 per GB/month
- 1PB = 1,000,000GB
- Cost = 1M × $0.023 = $23K/month

**Bandwidth** (AWS):
- Первый 1GB/month: бесплатно
- До 10TB: $0.09 per GB
- 200GB/sec × 2.5M sec/month = 500PB/month
- Cost ≈ $45M/month!

Вывод: нужен CDN для снижения costs.

**Database** (AWS RDS):
- db.r5.24xlarge: $13.92/hour, 768GB RAM
- $13.92 × 24 × 30 ≈ $10K/month за сервер

### Cache Hit Rate

Если 80% запросов в cache:
```
DB load = Total QPS × (1 - cache_hit_rate)
DB load = 100K QPS × 0.2 = 20K QPS
```

## Практические упражнения

### Задача 1: YouTube
- 1B пользователей
- 100M DAU
- Каждый смотрит 5 видео в день (средняя длительность 10 минут)
- Видео: 720p, ~1Mbps bitrate
- Рассчитайте bandwidth для видео стриминга

<details>
<summary>Решение</summary>

```
Video views per day = 100M × 5 = 500M views
Average video size = 10 min × 60 sec × 1Mbps / 8 = 75MB

Daily bandwidth = 500M × 75MB = 37.5PB
Bandwidth per second = 37.5PB / 100K sec ≈ 375GB/sec
```
</details>

### Задача 2: WhatsApp
- 2B пользователей
- 500M DAU
- Каждый отправляет 50 сообщений в день
- Среднее сообщение: 100 байт
- Рассчитайте QPS и storage за год

<details>
<summary>Решение</summary>

```
Write operations = 500M × 50 = 25B messages/day
Write QPS = 25B / 100K ≈ 250K writes/sec

Daily storage = 25B × 100 bytes = 2.5TB/day
Yearly storage = 2.5TB × 365 ≈ 912TB ≈ 1PB
With replication (×3): 3PB
```
</details>

### Задача 3: Dropbox
- 50M пользователей
- 10M DAU
- Каждый загружает 5 файлов в день
- Средний файл: 10MB
- Рассчитайте storage и bandwidth

<details>
<summary>Решение</summary>

```
Daily uploads = 10M × 5 = 50M files
Daily data = 50M × 10MB = 500TB

Write QPS = 50M / 100K = 500 uploads/sec
Bandwidth = 500 uploads/sec × 10MB = 5GB/sec

Yearly storage = 500TB × 365 = 182PB
With replication: 182PB × 3 = 546PB
```
</details>

## Шпаргалка для интервью

### Вопросы для уточнения масштаба
1. Сколько пользователей? (DAU/MAU)
2. Сколько операций делает типичный пользователь?
3. Какой размер данных в одной операции?
4. Какое соотношение read/write?
5. Сколько хранить данные?
6. Есть ли пиковые часы?

### Типичные значения
- **Текст сообщения**: 100-500 bytes
- **Пост в соцсети**: 500-1000 bytes
- **Фото**: 1-5MB
- **Видео (1 мин, 720p)**: 10-20MB
- **Read/Write ratio для соцсетей**: 100:1 или 1000:1
- **Peak/Average load**: 2-5x

### Порядок расчетов
1. QPS (write и read отдельно)
2. Storage
3. Bandwidth
4. Число серверов
5. Cache requirements

## Что почитать дальше

- "Back of the Envelope" by Jeff Dean — классическая презентация от Google
- [Latency Numbers Every Programmer Should Know](https://gist.github.com/jboner/2841832)
- "System Design Interview" by Alex Xu — Chapter 2 содержит детальные примеры

## Проверьте себя

1. Сколько секунд в дне? (упрощенное для расчетов)
2. Как рассчитать QPS, зная DAU и операций на пользователя?
3. Во сколько раз обычно Read QPS превышает Write QPS в социальных сетях?
4. Почему нужно умножать storage на 3?
5. Что такое Peak QPS и как его оценить?
6. Рассчитайте storage для системы: 1M пользователей, каждый генерирует 10KB в день, данные хранятся год.

## Ключевые выводы

- Back-of-the-envelope calculations — обязательный навык для system design
- Используйте упрощения: 100K секунд в дне, округляйте агрессивно
- Всегда учитывайте: репликацию, метаданные, пиковую нагрузку
- Озвучивайте допущения и показывайте ход мыслей
- Точность не критична — важен порядок величины
- Практика делает совершенным — решайте задачи регулярно

---
**Предыдущий урок**: [Введение в System Design](01-introduction-to-system-design.md)
**Следующий урок**: [Latency Numbers Every Programmer Should Know](03-latency-numbers.md)
